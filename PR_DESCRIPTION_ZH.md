## TLDR

ä¿®å¤åœ¨å®¹å™¨ç¯å¢ƒï¼ˆå¦‚ code-server è¿œç¨‹å¼€å‘ï¼‰ä¸­ï¼ŒIDE å®¢æˆ·ç«¯å›  `host.docker.internal` åŸŸåä¸å¯è¾¾è€Œæ— æ³•è¿æ¥çš„é—®é¢˜ã€‚

å°† `getIdeServerHost()` å‡½æ•°æ”¹ä¸ºå¼‚æ­¥ï¼Œåœ¨æ£€æµ‹åˆ°å®¹å™¨ç¯å¢ƒåï¼Œå…ˆé€šè¿‡ DNS æŸ¥è¯¢éªŒè¯ `host.docker.internal` æ˜¯å¦å¯è§£æï¼Œä¸å¯è¾¾æ—¶è‡ªåŠ¨å›é€€åˆ° `127.0.0.1`ã€‚

## Dive Deeper

### é—®é¢˜èƒŒæ™¯

åœ¨ Docker Desktop ä¸­ï¼Œ`host.docker.internal` ä¼šè‡ªåŠ¨é…ç½®ä¸ºæŒ‡å‘å®¿ä¸»æœºçš„ç‰¹æ®ŠåŸŸåã€‚ä½†åœ¨ä»¥ä¸‹ç¯å¢ƒä¸­è¯¥åŸŸåä¸ä¸€å®šå­˜åœ¨ï¼š

- **Linux Docker**ï¼šéœ€è¦æ‰‹åŠ¨æ·»åŠ  `--add-host=host.docker.internal:host-gateway`
- **code-server è¿œç¨‹ç¯å¢ƒ**ï¼šä¸è¿è¡Œåœ¨ Docker Desktop ä¸­ï¼Œæ²¡æœ‰è¯¥åŸŸå
- **Podman ç­‰å…¶ä»–å®¹å™¨è¿è¡Œæ—¶**ï¼šä¸ä¸€å®šæ”¯æŒè¯¥åŸŸå

åŸæœ‰å®ç°åªé€šè¿‡ `/.dockerenv` æˆ– `/run/.containerenv` æ–‡ä»¶æ£€æµ‹æ˜¯å¦åœ¨å®¹å™¨ä¸­ï¼Œä¸€æ—¦æ£€æµ‹åˆ°å°±ç›´æ¥ä½¿ç”¨ `host.docker.internal`ï¼Œä½†æœªéªŒè¯è¯¥åŸŸåæ˜¯å¦å®é™…å¯è¾¾ï¼Œå¯¼è‡´åœ¨ä¸Šè¿°ç¯å¢ƒä¸­ IDE è¿æ¥å¤±è´¥ã€‚

### ä¿®æ”¹å†…å®¹

1. **`getIdeServerHost()` æ”¹ä¸ºå¼‚æ­¥å‡½æ•°**ï¼šæ–°å¢ `dns.lookup` æ£€æŸ¥ `host.docker.internal` æ˜¯å¦å¯è§£æ
2. **ç»“æœç¼“å­˜**ï¼šé¦–æ¬¡æ£€æµ‹ç»“æœç¼“å­˜åˆ°æ¨¡å—çº§å˜é‡ `cachedIdeServerHost`ï¼Œé¿å…é‡å¤ DNS æŸ¥è¯¢
3. **debug æ—¥å¿—**ï¼šåœ¨å®¹å™¨ç¯å¢ƒä¸‹è¾“å‡º DNS æ£€æŸ¥ç»“æœï¼Œæ–¹ä¾¿æ’æŸ¥è¿æ¥é—®é¢˜
4. **å¯¼å‡ºæµ‹è¯•è¾…åŠ©å‡½æ•°**ï¼š`_resetCachedIdeServerHost()` ç”¨äºæµ‹è¯•é—´éš”ç¦»ç¼“å­˜çŠ¶æ€
5. **å®Œæ•´å•å…ƒæµ‹è¯•**ï¼šæ–°å¢ 6 ä¸ªæµ‹è¯•ç”¨ä¾‹è¦†ç›–æ‰€æœ‰åœºæ™¯

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶                                       | å˜æ›´         |
| ------------------------------------------ | ------------ |
| `packages/core/src/ide/ide-client.ts`      | æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ |
| `packages/core/src/ide/ide-client.test.ts` | æ–°å¢æµ‹è¯•ç”¨ä¾‹ |

## Reviewer Test Plan

1. æ‹‰å–åˆ†æ”¯åè¿è¡Œæµ‹è¯•ï¼š`npx vitest run packages/core/src/ide/ide-client.test.ts`
2. ç¡®è®¤æ‰€æœ‰ 24 ä¸ªæµ‹è¯•é€šè¿‡ï¼ˆå« 6 ä¸ªæ–°å¢ï¼‰
3. åœ¨ Docker å®¹å™¨ä¸­ï¼ˆæœ‰ `host.docker.internal`ï¼‰éªŒè¯ IDE è¿æ¥æ­£å¸¸
4. åœ¨ code-server è¿œç¨‹ç¯å¢ƒä¸­ï¼ˆæ—  `host.docker.internal`ï¼‰éªŒè¯ IDE è‡ªåŠ¨å›é€€åˆ° `127.0.0.1`

## Testing Matrix

|          | ğŸ  | ğŸªŸ  | ğŸ§  |
| -------- | --- | --- | --- |
| npm run  | âœ…  | â“  | â“  |
| npx      | â“  | â“  | â“  |
| Docker   | â“  | â“  | â“  |
| Podman   | â“  | -   | -   |
| Seatbelt | â“  | -   | -   |

## Linked issues / bugs

<!-- å¦‚æœ‰ç›¸å…³ issue è¯·åœ¨æ­¤å¤„å…³è” -->
